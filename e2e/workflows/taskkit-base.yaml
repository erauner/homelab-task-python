# E2E version of taskkit-base template
# Uses local image tag (set by e2e scripts) instead of production registry
# Supports context artifacts for step-to-step coordination
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: taskkit-base
  namespace: argo-workflows
  labels:
    homelab-tasks.dev/category: base
    homelab-tasks.dev/runtime: taskkit
    homelab-tasks.dev/environment: e2e
  annotations:
    description: "E2E base template for taskkit tasks - uses locally built image"
spec:
  serviceAccountName: argo-workflow
  templates:
    - name: run-task
      inputs:
        parameters:
          - name: task-name
            description: "Name of the task to run (e.g., 'echo', 'http_request')"
          - name: input-json
            description: "JSON input for the task"
          - name: context-json
            description: "Context JSON from previous step (optional)"
            default: '{"version":"taskkit-context/v1","vars":{}}'
      outputs:
        parameters:
          - name: result
            valueFrom:
              path: /outputs/result.json
          - name: context
            valueFrom:
              path: /outputs/context.json
      volumes:
        - name: io
          emptyDir: {}
      initContainers:
        - name: prepare-input
          image: alpine:3.19
          command: [sh, -c]
          args:
            - |
              mkdir -p /inputs /outputs
              # Write task input
              cat > /inputs/input.json << 'INPUTEOF'
              {{inputs.parameters.input-json}}
              INPUTEOF
              # Write context (from previous step or default empty)
              cat > /inputs/context.json << 'CTXEOF'
              {{inputs.parameters.context-json}}
              CTXEOF
              echo "Task: {{inputs.parameters.task-name}}"
              echo "Input prepared ($(wc -c < /inputs/input.json) bytes)"
              echo "Context prepared ($(wc -c < /inputs/context.json) bytes)"
          volumeMounts:
            - name: io
              mountPath: /inputs
              subPath: inputs
            - name: io
              mountPath: /outputs
              subPath: outputs
      container:
        # IMAGE_TAG is replaced by e2e/scripts/run.sh before applying
        image: taskkit:local
        imagePullPolicy: Never
        command: ["task-run", "run", "{{inputs.parameters.task-name}}"]
        args:
          - "--input"
          - "/inputs/input.json"
          - "--output"
          - "/outputs/result.json"
          - "--context"
        volumeMounts:
          - name: io
            mountPath: /inputs
            subPath: inputs
          - name: io
            mountPath: /outputs
            subPath: outputs
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "500m"
